---
- hosts: localhost
  tags:
    - classic
    - container
  vars:
  - artifacts: ./artifacts
    rootless_user: testuser
  roles:
  - role: rootless_user_ready

  tasks:
  # At the start of a run, clean up state. Useful for test reruns.
  - name: local artifacts directory exists
    local_action: file path="{{ artifacts }}" state=directory

  - name: remove stale log files
    local_action: shell rm -f {{ artifacts }}/test*.log

  - name: clear test results (test.log)
    local_action: command truncate --size=0 {{ artifacts }}/test.log

  - name: clear test results (results.yml)
    local_action: copy content="results:\n" dest={{ artifacts }}/results.yml

  # These are the actual tests: set cgroups vN, then run root/rootless tests.
  - name: set cgroups and run podman tests
    include_tasks: test_podman_cgroups_vn.yml
    loop: [ 2, 1 ]
    loop_control:
      loop_var: want_cgroups

  # Postprocessing: check for FAIL or ERROR in any test, exit 1 if so
  - name: check results
    include_tasks: check_results.yml
